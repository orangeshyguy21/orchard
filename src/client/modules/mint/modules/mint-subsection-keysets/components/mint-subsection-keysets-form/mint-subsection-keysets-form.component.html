<div class="mint-keyset-rotation-container p-t-1">
	<mat-card appearance="outlined" class="relative overflow-hidden">
		<mat-card-content class="orc-surface-container-low-bg">
			<div class="absolute top-0-5 right-0-5">
				<button mat-icon-button (click)="close.emit()">
					<mat-icon>close</mat-icon>
				</button>
			</div>
			<div class="flex flex-gap-2 flex-items-center flex-wrap">
				<div class="flex-1">
					<form
						class="flex-grow flex-1 flex flex-column flex-gap-1"
						[formGroup]="form_group()"
						(ngSubmit)="$event.preventDefault()"
						(keydown.enter)="$event.preventDefault()"
					>
						<div class="flex flex-row flex-gap-1 flex-wrap">
							<div>
								<div class="flex flex-row flex-gap-0-5">
									<div class="orc-small-form-field-wrapper">
										<mat-form-field
											appearance="fill"
											hideRequiredMarker="true"
											class="w-full orc-dynamic-form-field orc-hot-form-field"
										>
											<mat-label>Unit</mat-label>
											<mat-select formControlName="unit" (selectionChange)="onUnitChange($event)">
												@for (unit of unit_options(); track unit.value) {
													<mat-option [value]="unit.value">{{ unit.label }}</mat-option>
												}
											</mat-select>
										</mat-form-field>
									</div>

									<div class="p-t-0-5">
										<button
											type="button"
											tabindex="-1"
											mat-icon-button
											class="orc-icon-button"
											(click)="help_unit.set(!help_unit())"
										>
											<mat-icon class="orc-outline-color">info</mat-icon>
										</button>
									</div>
								</div>
							</div>
							<div class="orc-animation-expand-collapse" [class.animation-expanded]="help_unit()">
								<div class="orc-animation-expand-collapse-inner">
									<div class="flex p-b-1 w-max-18">
										<orc-form-help-text class="orc-surface-container-high-bg">
											<div>
												The unit of the keyset to rotate. Only existing units can be rotated. New units must be set
												in the mint config.
											</div>
										</orc-form-help-text>
									</div>
								</div>
							</div>
						</div>
						<div class="flex flex-row flex-gap-1 flex-wrap">
							<div>
								<div class="flex flex-row flex-gap-0-5">
									<div class="orc-small-form-field-wrapper">
										<mat-form-field
											appearance="fill"
											hideRequiredMarker="true"
											class="w-full orc-dynamic-form-field orc-hot-form-field"
										>
											<mat-label>Input Fee PPK</mat-label>
											<input
												type="text"
												formNumberSeparator
												matInput
												formControlName="input_fee_ppk"
												placeholder="Ex. 100"
											/>
											<mat-hint class="font-size-xs orc-outline-color">
												<span
													>Median tx fee would be
													<span
														class="font-weight-bold"
														[innerHTML]="
															keyset_in_fee_estimate | localAmount: form_group().get('unit')?.value : 'mint'
														"
													></span
												></span>
											</mat-hint>
											<mat-error>
												<orc-form-error [errors]="form_group().get('input_fee_ppk')?.errors">
													Invalid input fee PPK
												</orc-form-error>
											</mat-error>
										</mat-form-field>
									</div>
									<div class="p-t-0-5">
										<button
											type="button"
											tabindex="-1"
											mat-icon-button
											class="orc-icon-button"
											(click)="help_fee.set(!help_fee())"
										>
											<mat-icon class="orc-outline-color">info</mat-icon>
										</button>
									</div>
								</div>
							</div>
							<div class="orc-animation-expand-collapse" [class.animation-expanded]="help_fee()">
								<div class="orc-animation-expand-collapse-inner">
									<div class="flex p-b-1 w-max-18">
										<orc-form-help-text class="orc-surface-container-high-bg">
											<div>
												The transaction fee charged by a keyset is based on the number of ecash notes used in the
												transaction.
											</div>
										</orc-form-help-text>
									</div>
								</div>
							</div>
						</div>
                        <div class="flex">
                            <button matButton type="button" (click)="advanced.set(!advanced())">
                                <mat-icon>settings</mat-icon>
                                <span class="text-nowrap font-size-s">Advanced</span>
                            </button>
                        </div>

                        <div class="orc-animation-expand-collapse" [class.animation-expanded]="advanced()">
                            <div class="orc-animation-expand-collapse-inner">
                                <div class="category-rule"></div>
                                <div class="flex flex-column flex-gap-2 p-t-1">
                                    <div>
                                        <div class="title-form-section p-b-1">
                                            <span>Keyset Version</span>
                                        </div>
                                        <div class="flex flex-row flex-gap-1">
                                            <orc-form-toggle
                                                class="flex-1 h-min-6"
                                                [selected]="!form_group().get('keyset_v2')?.value"
                                                (click)="form_group().get('keyset_v2')?.setValue(false)"
                                            >
                                                <div class="keyset-version-sticker">
                                                    <span class="font-weight-bold">V1</span>
                                                    <mat-icon class="icon-lg">key</mat-icon>
                                                </div>
                                                <div class="keyset-version-label">
                                                    <div class="font-size-s">Old format</div>
                                                    <div class="font-size-xs orc-outline-color">8 byte keyset IDs</div>
                                                </div>
                                                
                                            </orc-form-toggle>
                                            <orc-form-toggle
                                                class="flex-1 h-min-6"
                                                [selected]="form_group().get('keyset_v2')?.value"
                                                [disabled]="mint_type() === 'nutshell'"
                                                (click)="form_group().get('keyset_v2')?.setValue(true)"
                                            >
                                                <div class="keyset-version-sticker">
                                                    <span class="font-weight-bold">V2</span>
                                                    <mat-icon class="icon-lg">key</mat-icon>
                                                </div>
                                                <div class="keyset-version-label">
                                                    <div class="font-size-s">New standard</div>
                                                    <div class="font-size-xs orc-outline-color">{{ keyset_v2_desc() }}</div>
                                                </div>
                                            </orc-form-toggle>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="title-form-section">
                                            <span>Ecash Amounts</span>
                                        </div>
                                        <div class="amount-slider">
                                            <div>
                                                <mat-checkbox formControlName="default_amounts">
                                                    <span class="font-size-s text-nowrap">Powers of 2</span>
                                                </mat-checkbox>
                                            </div>
                                            <mat-slider min="1" max="255" step="1" showTickMarks discrete class="amount-slider">
                                                <input matSliderThumb formControlName="max_order" (valueChange)="onMaxOrderChange()" />
                                            </mat-slider>
                                        </div>
                                        <div class="flex flex-row flex-items-center flex-gap-0-5">
                                            <mat-form-field class="w-full">
                                                <mat-chip-grid
                                                    #chipGrid
                                                    aria-label="Enter amounts"
                                                    [disabled]="form_group().get('default_amounts')?.value"
                                                >
                                                    @for (amount of form_group().get('amounts')?.value; track amount) {
                                                        <mat-chip-row
                                                            (removed)="removeAmount(amount)"
                                                            [editable]="!form_group().get('default_amounts')?.value"
                                                            (edited)="editAmount(amount, $event)"
                                                            [aria-description]="'press enter to edit ' + amount"
                                                        >
                                                            @if (!form_group().get('default_amounts')?.value) {
                                                                <button matChipEdit [attr.aria-label]="'edit ' + amount">
                                                                    <mat-icon>edit</mat-icon>
                                                                </button>
                                                            }
                                                            {{ form_group().get('default_amounts')?.value ? (amount | number) : amount }}
                                                            @if (!form_group().get('default_amounts')?.value) {
                                                                <button matChipRemove [attr.aria-label]="'remove ' + amount">
                                                                    <mat-icon>cancel</mat-icon>
                                                                </button>
                                                            }
                                                        </mat-chip-row>
                                                    }
                                                </mat-chip-grid>
                                                @if (!form_group().get('default_amounts')?.value) {
                                                    <input
                                                        placeholder="New amount..."
                                                        [matChipInputFor]="chipGrid"
                                                        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                                        [matChipInputAddOnBlur]="true"
                                                        (matChipInputTokenEnd)="addAmount($event)"
                                                    />
                                                }
                                            </mat-form-field>
            
                                            <div class="p-t-0-5">
                                                <button
                                                    type="button"
                                                    tabindex="-1"
                                                    mat-icon-button
                                                    class="orc-icon-button"
                                                    (click)="help_amounts.set(!help_amounts())"
                                                >
                                                    <mat-icon class="orc-outline-color">info</mat-icon>
                                                </button>
                                            </div>
                                        </div>
            
                                        <div class="orc-animation-expand-collapse" [class.animation-expanded]="help_amounts()">
                                            <div class="orc-animation-expand-collapse-inner">
                                                <div class="flex p-b-1 w-max-18">
                                                    <orc-form-help-text class="orc-surface-container-high-bg">
                                                        <div>The ecash denomination amounts that this keyset can create.</div>
                                                    </orc-form-help-text>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
					</form>
				</div>
				<div class="flex-1">
					<orc-mint-subsection-keysets-rotation-preview
						[keyset_in_unit]="form_group().get('unit')?.value"
						[keyset_in_index]="keyset_out().derivation_path_index + 1"
						[keyset_in_fee]="form_group().get('input_fee_ppk')?.value"
						[keyset_out_unit]="keyset_out().unit"
						[keyset_out_index]="keyset_out().derivation_path_index"
						[keyset_out_fee]="keyset_out().input_fee_ppk"
						[keyset_out_balance]="keyset_out_balance()?.balance"
					></orc-mint-subsection-keysets-rotation-preview>
				</div>
			</div>
		</mat-card-content>
	</mat-card>
</div>
