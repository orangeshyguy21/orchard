<div class="crew-table-container">
	@if (!loading() && data()) {
		<div class="p-h-1 flex flex-column flex-grow flex-justify-between" animate.enter="orc-animation-fadein">
			<table mat-table multiTemplateDataRows [dataSource]="data()" matSort class="orc-feature-table orc-expandable-table">
				<ng-container matColumnDef="user">
					<th mat-header-cell *matHeaderCellDef mat-sort-header class="crew-sticky-header">User</th>
					<td mat-cell *matCellDef="let entity">
						<div class="flex flex-items-center flex-gap-1 p-v-0-5">
							@if (entity.name) {
                                <orc-crew-member-chip [name]="entity.name" [role]="entity.role">
                                    <orc-crew-facehash [name]="entity.name" [enableBlink]="id_user() === entity.id"></orc-crew-facehash>
                                </orc-crew-member-chip>
							} @else {
								<div class="crew-icon invite-icon">
									<mat-icon>confirmation_number</mat-icon>
								</div>
								<div class="flex flex-column flex-gap-0-25">
									<i class="orc-outline-color"> pending </i>
									<span class="font-size-xs font-weight-bold"> {{ entity.role }} </span>
								</div>
							}
						</div>
					</td>
				</ng-container>

				<ng-container matColumnDef="label">
					<th mat-header-cell *matHeaderCellDef mat-sort-header class="crew-sticky-header">Label</th>
					<td mat-cell *matCellDef="let entity">
						@if (entity.label) {
							<div>{{ entity.label }}</div>
						} @else {
							<span class="font-size-m orc-outline-color">
								<mat-icon>check_indeterminate_small</mat-icon>
							</span>
						}
					</td>
				</ng-container>

				<ng-container matColumnDef="created">
					<th mat-header-cell *matHeaderCellDef mat-sort-header class="crew-sticky-header">Created</th>
					<td mat-cell *matCellDef="let entity">
						<span class="text-nowrap"> {{ entity.created_at | localTime: 'short' }} </span>
					</td>
				</ng-container>

				<ng-container matColumnDef="state">
					<th mat-header-cell *matHeaderCellDef mat-sort-header class="crew-sticky-header">State</th>
					<td mat-cell *matCellDef="let entity">
						@if (entity.name) {
							<div class="flex">
								<div class="label-state" [ngClass]="{'label-success': entity.active, 'label-default': !entity.active}">
									{{ entity.active ? 'Active' : 'Inactive' }}
								</div>
							</div>
						} @else {
							<div class="flex flex-items-center flex-gap-1">
								<div class="flex">
									<div class="label-state label-warning">Pending</div>
								</div>
								@if (entity.expires_at && device_type() === 'desktop') {
									<div class="text-nowrap orc-outline-color">
										Exipres in {{ entity.expires_at | localTimeDelta: now }}
									</div>
								}
							</div>
						}
					</td>
				</ng-container>

				<ng-container matColumnDef="actions">
					<th mat-header-cell *matHeaderCellDef class="crew-sticky-header">Actions</th>
					<td mat-cell *matCellDef="let entity">
						@if (id_user() !== entity.id) {
							<div class="flex flex-items-center flex-gap-0-5">
								<button
									mat-icon-button
									class="orc-icon-button"
									matTooltip="Edit"
									matTooltipPosition="above"
									(click)="$event.stopPropagation(); $event.preventDefault(); onEdit(entity)"
								>
									<mat-icon>edit</mat-icon>
								</button>

								<button
									mat-icon-button
									class="orc-icon-button"
									matTooltip="Delete"
									matTooltipPosition="above"
									(click)="$event.stopPropagation(); $event.preventDefault(); onDelete(entity)"
								>
									<mat-icon>delete_forever</mat-icon>
								</button>
							</div>
						}
					</td>
				</ng-container>

				<ng-container matColumnDef="more_detail">
					<td mat-cell *matCellDef="let entity" [attr.colspan]="displayed_columns().length">
						<div class="more-entity-wrapper" [class.more-entity-wrapper-expanded]="more_entity()?.id === entity.id">
							<div class="more-entity-content">
								@if (more_entity()?.id === entity.id) {
									<div animate.enter="orc-animation-fadein" class="flex-grow">
										@switch (more_entity_type()) {
											@case (MoreEntityType.VIEW_TOKEN) {
												<orc-index-subsection-crew-table-invite
													[invite]="entity"
													[device_desktop]="device_type() === 'desktop'"
													(editInvite)="onEdit(entity)"
													(deleteInvite)="onDelete(entity)"
												></orc-index-subsection-crew-table-invite>
											}
											@case (MoreEntityType.VIEW_USER) {
												<orc-index-subsection-crew-table-user
													[user]="entity"
													[is_self]="id_user() === entity.id"
													[is_admin]="entity.role === UserRole.Admin"
													[device_desktop]="device_type() === 'desktop'"
													(editUser)="onEdit(entity)"
													(deleteUser)="onDelete(entity)"
												></orc-index-subsection-crew-table-user>
											}
											@case (MoreEntityType.EDIT_INVITE) {
												<div class="p-b-1">
													<orc-index-subsection-crew-form-invite
														[form_group]="form_invite()"
														[open]="true"
														[mode]="'edit'"
														[role_options]="role_options()"
														(close)="onCloseInvite(entity)"
														(cancel)="onCancelInviteControl($event)"
													></orc-index-subsection-crew-form-invite>
												</div>
											}
											@case (MoreEntityType.EDIT_USER) {
												<div class="p-b-1">
													<orc-index-subsection-crew-form-user
														[form_group]="form_user()"
														[id_entity]="entity.id"
														[role_options]="role_options()"
														(close)="onCloseUser(entity)"
														(cancel)="onCancelUserControl($event)"
													></orc-index-subsection-crew-form-user>
												</div>
											}
										}
									</div>
								}
							</div>
						</div>
					</td>
				</ng-container>

				<tr mat-header-row *matHeaderRowDef="displayed_columns(); sticky: true"></tr>
				<tr
					mat-row
					*matRowDef="let row; columns: displayed_columns()"
					class="entity-row"
					[class.expanded]="more_entity === row"
					(click)="onToggleMore(row)"
				></tr>
				<tr mat-row *matRowDef="let row; columns: ['more_detail']" class="more-entity-row"></tr>
			</table>
		</div>
	} @else {
		<div class="flex flex-items-center flex-justify-center h-min-18">
			<mat-icon class="icon-lg mat-symbol-outline orc-outline-variant-color">table</mat-icon>
		</div>
	}
</div>
